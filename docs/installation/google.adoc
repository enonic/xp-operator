= Google Kubernetes Engine - GKE
:toc: right
:imagesdir: images
:experimental:

Instructions on setting up a managed k8s cluster on Google Cloud Platform - GCP

== Prerequisites

You will need the following:

A Google account and project:: Log in to https://cloud.google.com[GCP], and select or create a `Project` where you will create the k8s cluster. 

Gcloud CLI:: Command-line tool to manage resources in GCP. Download it https://cloud.google.com/sdk/docs/install[here]

Kubectl:: The Kubernetes command-line tool, kubectl, allows you to run commands against Kubernetes clusters. Download it https://kubernetes.io/docs/tasks/tools/install-kubectl/[here].


== Create a GKE Cluster

. *Enable the Kubernetes Engine API*. If the kubernetes engine API is not enabled for your GCP project, you need to enable it. 
+
image::../images/gkeEnablek8sapi.png[Enable API]
+
. Click btn:[Create] to launch the k8s cluster wizard. 
+
image::../images/gkeCreateClusterPage.png[Create GKE Cluster]
+
TIP: If you don't get see this page, Choose `Kubernetes Engine` -> `clusters` from the main menu.
+
. The XP Operator *does not support Autopilot clusters*, choose the `Standard` clusters instead.
+
. Follow the cluster creation steps by setting the values based on your cluster needs. 
+
WARNING: Make sure to chose kubernetes version >= 1.27 which is requried by XP operator.


== Connect to the cluster

. Once the k8s cluster is created, click the cluster name
. Then click btn:[Connect] on the top middle section of the page. This shows you the gcloud command you can use to connect to the k8s cluster from your computer.
. Copy and run the gcloud command. If the command outputs `kubeconfig entry generated for <newly-created-k8s-cluster-name>`, it means proper kubectl config is generated on your computer and you are successfully authenticated to the k8s cluster. 
. To verify your access to the k8s cluster run the command
+
[source,terminal]
----
kubectl get namespaces
----
+
This should display the list of namespaces in the newly created k8s cluster. The "Age" column in the output shows how long has it been since the namespaces are created. 


== Storage classes

XP will require specific storage classes in order to work properly. List the available storage classes using the following command:

[source,terminal]
----
kubectl get storageclasses
----

TODO: Example

This should display the list of storage classes provisioned by GKE cluster.


== Teardown

Once you are done with your cluster, you can delete the k8s cluster from the GCP console or using gcloud cli:

[source,bash]
----
gcloud container clusters delete <CLUSTER_NAME> --region <REGION_NAME>
----



TODO: Remove below

== Run XP in Cluster Mode

To run xp in cluster mode it is required to have an NFS based shared volume that can be mounted as Read-Write by multiple nodes at a time. The standard storage class in `GKE` does not support `ReadWriteMany` mode. Most storage classes that support `ReadWriteMany` access mode have also a restriction in changing the modified time of files that XP requires. 

In GKE, Filestore CSI driver based storage class with RWM* mode can be used to deploy XP in cluster mode. However it is an expensive option due to :
1. Very high minimum allowed size 
2. higher cost per GB

Another alternative is to mount a disk from an existing external NFS server or use a provisoner to create NFS server in your GKE cluster and create an NFS based storage class from it. See our <<nfs#,NFS storage class>> guide for more information.

Note: If you have already deployed XP operator with NFS based shared storage class, you can continue to the next step. If not update the values.yaml file from above and follow the steps in section [Deploy XP Operator in k8s]. After deploying the XP operator with shared storage support, you can continue to the next steps.

=== XP deployment in cluster Mode

You can get example deployment file to deploy XP in cluster mode from
link:/https://github.com/enonic/xp-operator/kubernetes[Example Codes]. Copy cluster-xp7deployment-with-other-resources.yaml deployment file
and make changes to it as per your requirement. For instance parameters like namespace in which XP is going to be deployed, RAM and CPU size, types and number of cluster nodes can be changed in the deployment file. Once you finished editing the file, run the command below.


[source,bash]
----
$ kubectl apply -f cluster-xp7deployment-with-other-resources.yaml

namespace/my-namespace created
xp7deployment.enonic.cloud/my-deployment created
xp7app.enonic.cloud/contentstudio created
xp7config.enonic.cloud/my-config created
ingress.networking.k8s.io/my-domain-com created
----

==== Access admin (through ingress)

If you have setup ingress controller, you can access xp-admin through the admin end point you configured.

